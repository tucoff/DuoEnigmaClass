<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Enigmas Cooperativos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pastel-green': { 100: '#EDF7ED', 200: '#C8E6C9' },
                        'pastel-violet': { light: '#D1C4E9', DEFAULT: '#9575CD', dark: '#4A3B6B' },
                        'pastel-red': { DEFAULT: '#FFAB91', hover: '#FF8A65' }
                    },
                    fontFamily: { 'sans': ['Poppins', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>.pulse-text { animation: pulse 2s infinite; } @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }</style>
</head>
<body class="bg-pastel-green-100 text-pastel-violet-dark font-sans min-h-screen font-medium">

    <div class="container mx-auto p-4 sm:p-6 max-w-3xl">
        <header class="text-center mb-8 mt-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-pastel-violet-dark mb-3">Enigmas Cooperativos</h1>
            <p class="text-lg opacity-80">Ferramenta do Professor: Transforme o livro em gamificação.</p>
        </header>
        
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-pastel-violet-light flex flex-col items-center text-center">
                <div class="p-3 bg-pastel-violet-light/20 rounded-full mb-3 text-pastel-violet-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.122 2.122 0 0 0-.863-.694l-2.685-1.11a3.84 3.84 0 0 0-1.418-.308H9.12c-.525 0-1.046.103-1.535.308l-2.685 1.11a2.122 2.122 0 0 0-.863.694l-.822 1.316Z" />
                    </svg>                      
                </div>
                <h3 class="font-bold">1. Tire Fotos</h3>
                <p class="text-xs text-gray-500">Das páginas do livro</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-pastel-violet-light flex flex-col items-center text-center">
                <div class="p-3 bg-pastel-violet-light/20 rounded-full mb-3 text-pastel-violet-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.225 19.763 17.438 22l-.787-2.237a2.25 2.25 0 0 0-1.538-1.538L12.9 17.438l2.213-.787a2.25 2.25 0 0 0 1.538-1.538L17.438 12.9l.787 2.213a2.25 2.25 0 0 0 1.538 1.538L22 17.438l-2.237.787a2.25 2.25 0 0 0-1.538 1.538Z" />
                    </svg>                      
                </div>
                <h3 class="font-bold">2. A IA Cria</h3>
                <p class="text-xs text-gray-500">5 Desafios Únicos</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-pastel-violet-light flex flex-col items-center text-center">
                <div class="p-3 bg-pastel-violet-light/20 rounded-full mb-3 text-pastel-violet-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                    </svg>                      
                </div>
                <h3 class="font-bold">3. Imprima</h3>
                <p class="text-xs text-gray-500">Cartas + Gabarito</p>
            </div>
        </section>

        <main class="bg-white p-6 sm:p-8 rounded-3xl shadow-lg border-2 border-pastel-violet-light/30">
            <div class="mb-8">
                <label for="imageInput" class="cursor-pointer flex flex-col items-center justify-center w-full h-32 border-3 border-dashed border-pastel-violet-light rounded-2xl bg-pastel-green-100/50 hover:bg-pastel-violet-light/10 transition-colors group">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-10 h-10 mb-3 text-pastel-violet group-hover:text-pastel-violet-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"/></svg>
                        <p class="text-sm text-pastel-violet-dark"><span class="font-bold">Clique para adicionar páginas</span> (Várias fotos)</p>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" multiple class="hidden" />
                </label>
            </div>

            <div id="imagePreviewGrid" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 empty:hidden"></div>

            <div class="mb-6">
                <label for="difficultySelect" class="block text-pastel-violet-dark font-bold mb-2 pl-1">Nível da Turma:</label>
                <div class="relative">
                    <select id="difficultySelect" class="block w-full bg-white border-2 border-pastel-violet-light text-pastel-violet-dark py-3 px-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-pastel-violet-light/50">
                        <option value="1">Nível 1 - Muito Fácil (Identificação)</option>
                        <option value="2">Nível 2 - Fácil (Compreensão)</option>
                        <option value="3" selected>Nível 3 - Médio (Aplicação)</option>
                        <option value="4">Nível 4 - Difícil (Análise)</option>
                        <option value="5">Nível 5 - Expert (Síntese)</option>
                    </select>
                </div>
            </div>

            <button id="generateBtn" class="w-full bg-pastel-red hover:bg-pastel-red-hover text-white font-bold py-4 px-6 rounded-2xl shadow-md text-lg transition transform hover:-translate-y-1">
                Gerar 5 Provas Cooperativas
            </button>

            <div id="loadingIndicator" class="hidden mt-8 text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-pastel-violet-light border-t-pastel-violet-dark mb-4"></div>
                <p id="loadingText" class="text-pastel-violet-dark font-medium pulse-text">Lendo o livro...</p>
            </div>

            <div id="resultsArea" class="hidden mt-10 border-t-2 border-pastel-violet-light/30 pt-8">
                <h2 class="text-2xl font-bold text-pastel-violet-dark mb-6">Sucesso! Enigmas Gerados.</h2>
                
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 text-sm text-blue-800">
                    <p class="font-bold">Confira abaixo uma prévia.</p>
                    <p>O PDF gerado terá <strong>1 enigma por página</strong> (para os alunos) e uma página final com o <strong>Gabarito</strong> (para você).</p>
                </div>

                <div id="enigmasList" class="space-y-6"></div>
                
                <button id="downloadPdfBtn" class="w-full mt-8 bg-pastel-violet-dark hover:bg-opacity-90 text-white font-bold py-4 px-6 rounded-2xl shadow-md text-lg flex justify-center items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Baixar PDF (Cartas + Gabarito)
                </button>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;
        const imageInput = document.getElementById('imageInput');
        const imagePreviewGrid = document.getElementById('imagePreviewGrid');
        const generateBtn = document.getElementById('generateBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingText = document.getElementById('loadingText');
        const resultsArea = document.getElementById('resultsArea');
        const enigmasList = document.getElementById('enigmasList');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');

        let selectedImages = []; 
        let generatedEnigmasData = [];

        // --- Banco de Dados de Exemplos (Few-Shot Learning) ---
        const examplesDatabase = [
            // --- NÍVEL 1: MUITO FÁCIL (Identificação) ---
            {
                difficulty: 1,
                titulo: "1ª Lei de Newton (Inércia)",
                enigma: "Eu sou uma lei muito famosa, talvez a mais famosa de todas as leis do movimento. O meu nome começa com a letra I e eu represento uma certa teimosia da natureza. Eu sou aquela regra que diz que as coisas gostam de ficar como estão. Se uma pedra está parada no chão, em repouso, ela quer continuar parada para sempre. Ela não vai sair andando sozinha por vontade própria. Por outro lado, se uma nave espacial está voando no espaço profundo, longe de tudo, em movimento uniforme, ela vai continuar voando para sempre, sem nunca parar e sem nunca fazer curvas. Ela segue em uma linha reta eternamente. O seu texto tem uma frase muito especial, um enunciado original traduzido que explica exatamente isso. Ele diz que 'todo corpo continua em seu estado', seja ele parado ou andando retinho. Para mudar essa situação, só existe um jeito: é preciso que algo externo aconteça. É preciso que ela seja forçada a mudar. É preciso que existam forças aplicadas sobre ela. Sem essa força resultante, nada muda. Eu sou a tendência de manter tudo igual. Procure pelo parágrafo que define a Lei da Inércia e o comportamento de todo corpo. Quem sou eu?",
                paragrafo_original: "A Primeira Lei de Newton é chamada de Lei da Inércia. Seu enunciado original encontra-se traduzido abaixo: “Todo corpo continua em seu estado de repouso ou de movimento uniforme em uma linha reta, a menos que seja forçado a mudar aquele estado por forças aplicadas sobre ele.” Essa lei diz que, ao menos que haja alguma força resultante não nula sobre um corpo, esse deverá manter-se em repouso ou se mover ao longo de uma linha reta com velocidade constante.",
                resposta: "Lei da Inércia (Primeira Lei de Newton)."
            },

            // --- NÍVEL 2: FÁCIL (Compreensão) ---
            {
                difficulty: 2,
                titulo: "Sistemas de Alianças",
                enigma: "Imagine um grande baile onde ninguém quer dançar sozinho, pois o salão está perigoso e cheio de armadilhas. Neste baile da morte, as nações decidiram dar as mãos e formar grupos, prometendo proteger umas às outras caso a música parasse e a briga começasse. O seu livro descreve exatamente como esse salão se dividiu no início da grande confusão. Não havia espaço para indecisos; o mundo se partiu em dois grandes times. De um lado do salão, vestindo as cores das Potências Centrais, formou-se um grupo liderado pela força industrial da Alemanha. Eles não estavam sós; trouxeram consigo a velha Áustria-Hungria, o vasto Império Turco-Otomano e, mais tarde, a pequena Bulgária. Eles formaram um trio poderoso, uma aliança tripla. Mas olhe para o outro lado do salão. Lá, três gigantes decidiram que precisavam se unir para conter o avanço dos primeiros. Eles formaram a Entente, um acordo cordial mas armado até os dentes. Vemos o gigante do leste, a Rússia, dando as mãos à republicana França e à senhora dos mares, a Inglaterra. Eu preciso que você encontre o parágrafo que nomeia esses dois times. Procure pelos nomes dos países e me diga como se chamavam esses dois grupos rivais que dividiram o mapa e o destino do mundo.",
                paragrafo_original: "Assim, no início, os países se dividiram em dois lados: Tríplice Aliança e Tríplice Entente. No primeiro grupo, também chamado de Potências Centrais, estavam a Alemanha, Áustria-Hungria, Império Turco-Otomano e Bulgária. Do outro lado estavam a Rússia, a França e a Inglaterra.",
                resposta: "Tríplice Aliança e Tríplice Entente."
            },
            {
                difficulty: 2,
                titulo: "2ª Lei de Newton (F=ma)",
                enigma: "Para me decifrar, você não precisa ser um matemático, mas precisa encontrar uma receita muito especial escrita no seu livro. Esta não é uma receita de bolo, mas a receita de como mover o mundo. Ela explica o segredo de como empurrar as coisas e fazê-las ganharem velocidade. O texto apresenta uma fórmula curta, elegante, com apenas três letras, mas que governa todos os carros, foguetes e bolas de futebol do planeta. Estou procurando a representação matemática da Segunda Lei. Nessa fórmula mágica, o resultado final é a Força Resultante, que nós medimos em homenagem ao próprio Isaac, usando Newtons. Mas essa força não aparece do nada; ela é o produto, a multiplicação de duas outras coisas. A primeira é a quantidade de matéria que um corpo tem, que chamamos de massa e pesamos em quilogramas. A segunda é a mudança rápida de velocidade, a aceleração, que medimos em metros por segundo ao quadrado. O enigma é simples: encontre a linha que mostra essa equação. Ela diz que 'F' é igual a 'm' vezes 'a'. É a regra que diz que para acelerar algo pesado (massa grande), você precisa de muita força. Localize essa expressão matemática e as definições de suas unidades no Sistema Internacional.",
                paragrafo_original: "Representamos a Segunda Lei matematicamente como: FR = m. a. Onde, FR: força resultante. A unidade no sistema internacional é o Newton (N). m: massa. A unidade no sistema internacional é o quilograma (kg). a: aceleração. A unidade no sistema SI é o metro por segundo ao quadrado (m/s²).",
                resposta: "A fórmula FR = m. a e suas definições."
            },

            // --- NÍVEL 3: MÉDIO (Aplicação) ---
            {
                difficulty: 3,
                titulo: "Guerra de Trincheiras",
                enigma: "Não estamos mais marchando. A época das grandes caminhadas e das batalhas rápidas em campos abertos acabou. Agora, a nossa realidade é estática, suja e subterrânea. Eu sou um soldado preso em uma cicatriz aberta na terra, uma longa vala cavada que corta a Europa de ponta a ponta. O seu livro descreve o meu pesadelo diário, uma fase do conflito onde o avanço parou e a resistência começou. Procure o trecho que descreve onde nós moramos agora. Não são casas, são buracos. Estamos cercados não por cercas brancas, mas por rolos infinitos de arame farpado que rasgam a pele e o uniforme. O inimigo não é apenas o soldado do outro lado com sua metralhadora; o inimigo está aqui dentro conosco. O texto fala de assassinos silenciosos que não usam fardas: a lama que suga nossas botas e apodrece nossos pés, o frio que congela nossos ossos durante a noite, e as doenças terríveis como o tifo. Ah, e não esqueça dos ratos, que correm por entre nós sem medo. Essa foi a fase mais cruel e longa da guerra, onde franceses e alemães ficaram encarando um ao outro através da 'terra de ninguém', sem conseguir avançar um metro sequer. Que nome o historiador dá para esse momento de buracos, terra e morte estática? Encontre a descrição desse inferno.",
                paragrafo_original: "Depois, franceses e alemães firmaram posições cavando trincheiras ao longo de toda a frente ocidental. Protegidos por arame farpado, os exércitos se enterravam nos buracos, onde a lama, o frio, os ratos e o tifo matavam tanto quanto as metralhadoras e canhões. Este momento do conflito é chamado de Guerra de Trincheiras.",
                resposta: "Guerra de Trincheiras."
            },
            {
                difficulty: 3,
                titulo: "3ª Lei de Newton (Ação e Reação)",
                enigma: "Vamos sair da teoria e ir para o estacionamento de um supermercado. Quero propor um experimento mental que prova que você não pode tocar o mundo sem que o mundo toque você de volta. Imagine que você colocou patins nos pés, daqueles com rodas bem lisas, que deslizam facilmente pelo chão. Diante de você está um carrinho de compras, mas ele não está vazio; está lotado, pesado, cheio de mantimentos. Sua missão é empurrar esse carrinho para frente. Você estende os braços, firma as mãos na barra e faz força. O que acontece? O senso comum diz que o carrinho vai para frente e você fica parado. Mas a Física, e a Terceira Lei de Newton, dizem algo diferente. O texto que você tem aí descreve exatamente essa cena cômica. Ele explica que, ao aplicar a força no carrinho, o carrinho devolve a força em você. Como você está sobre rodas e o atrito com o chão é muito fraco, algo surpreendente acontece com o seu corpo. Em vez de ficar firme, você é lançado na direção oposta. Você vai para trás. Encontre o exemplo prático no texto que usa patins e um carrinho de supermercado para ilustrar a inevitabilidade da reação. Leia para mim o que acontece 'em decorrência da fraca intensidade' do atrito. O que essa cena prova sobre as forças?",
                paragrafo_original: "Por exemplo: se estivermos usando patins e empurrarmos um carrinho de supermercado lotado de compras, seremos empurrados para trás, em decorrência da fraca intensidade da força de atrito entre as rodas dos patins e o piso.",
                resposta: "O exemplo dos patins e do carrinho, demonstrando a reação que empurra a pessoa para trás."
            },

            // --- NÍVEL 4: DIFÍCIL (Análise) ---
            {
                difficulty: 4,
                titulo: "Escalada do Conflito",
                enigma: "Este enigma é sobre como transformar uma faísca em um incêndio florestal. Fala sobre a terrível mecânica das alianças automáticas, onde ninguém podia escolher ficar de fora. Inicialmente, parecia uma briga regional, uma disputa de vizinhos: a Áustria estava zangada com a Sérvia. Poderia ter acabado ali, em uma semana de tensão localizada. Mas o texto narra uma sequência de eventos vertiginosa, um verdadeiro efeito dominó diplomático. Eu preciso que você rastreie essa cadeia de reações imprudentes. Veja como a Rússia, querendo mostrar força nos Balcãs, decide intervir para ajudar o irmão menor, a Sérvia. Mas esse movimento acorda o gigante industrial vizinho. A Alemanha, vendo a Rússia se mover, não espera: reage imediatamente e declara guerra ao czar. Mas a loucura não para por aí. Para atingir seus objetivos, a Alemanha atropela a neutralidade de pequenos países, invadindo Luxemburgo e ameaçando a Bélgica. E como em um jogo de xadrez mortal, o movimento alemão força a França, velha aliada dos russos, a entrar no tabuleiro, mobilizando suas tropas nas fronteiras. É uma cascata de decisões onde 'um acode o outro' e 'o outro ataca o amigo daquele'. Encontre o parágrafo longo que descreve essa semana fatídica, onde a guerra deixou de ser austro-sérvia e se tornou europeia. Quem reagiu a quem? Qual foi a sequência exata descrita no seu livro?",
                paragrafo_original: "Durante uma semana, os enfrentamentos permaneceram entre Áustria e Sérvia, mas a Rússia resolveu acudir esta última para reforçar sua posição nos Balcãs. A Alemanha, então, reage se posicionando a favor da Áustria, declarando guerra à Rússia. Além disso, invadiu Luxemburgo e emitiu um ultimato à Bélgica. Aliada dos russos, a França inicia a mobilização de tropas contra os alemães e são registrados atritos na fronteira entre os dois países.",
                resposta: "A sequência de declarações de guerra e mobilizações: Áustria-Sérvia > Rússia > Alemanha > França."
            },
            {
                difficulty: 4,
                titulo: "Conceito de Massa Inercial",
                enigma: "Muitas pessoas confundem quem eu sou. Acham que sou apenas um número na balança da farmácia, algo que diz se você engordou ou emagreceu. Mas na visão profunda de Isaac Newton, eu sou algo muito mais fundamental. Eu não sou o peso; eu sou a medida da inércia. Eu sou a definição de 'dificuldade'. Eu sou aquilo que resiste à mudança. O seu texto traz uma explicação sofisticada sobre o meu papel na Segunda Lei. Ele diz que eu sou a 'constante de proporcionalidade'. O que isso significa? Significa que eu sou o juiz que decide o quanto um empurrão vai ser eficaz. O enigma propõe um experimento comparativo: imagine que você aplica exatamente a mesma força em dois objetos diferentes. Um é leve, o outro é pesadíssimo. O que acontece? A matemática da natureza é implacável. O objeto que tiver mais de mim (maior massa) vai sofrer uma aceleração menor. Ele vai ser teimoso, lento para começar a andar. Já o objeto com menos massa vai disparar. O texto conclui algo belíssimo: ter muita massa significa 'resistir mais às variações de velocidade'. Encontre o parágrafo que explica essa relação inversa. Onde diz que, para a mesma força, quanto maior a massa, menor a aceleração? Encontre a definição física da minha resistência.",
                paragrafo_original: "Na 2ª Lei, a massa do objeto (m) é a constante de proporcionalidade da equação e é a medida da inércia de um corpo. Assim, se aplicarmos a mesma força a dois corpos com massas diferentes, o de maior massa sofrerá uma aceleração menor. Disso concluímos que aquele que tem maior massa resiste mais às variações de velocidade, logo tem maior inércia.",
                resposta: "A explicação de que a massa é a medida da inércia."
            },

            // --- NÍVEL 5: SUPER DIFÍCIL (Síntese) ---
            {
                difficulty: 5,
                titulo: "Consequências do Tratado de Versalhes",
                enigma: "Este é o paradoxo final da Grande Guerra: a paz que foi assinada não trouxe tranquilidade, mas sim a garantia de um novo apocalipse. Estamos em 1919, no Salão dos Espelhos. O documento sobre a mesa tem um nome elegante, batizado em homenagem a um palácio francês, mas o seu conteúdo é puro veneno diplomático. O texto que você procura revela a natureza punitiva deste acordo. Ele não foi negociado; foi imposto. Leia com atenção as linhas que detalham a humilhação sistemática de uma nação. Veja como a Alemanha foi desmembrada: tiraram-lhe as terras ultramarinas na África, amputaram partes do seu próprio solo europeu (como a Alsácia e Lorena) e algemaram suas forças armadas, proibindo-a de ter um exército real. E não bastasse isso, enviaram uma conta impagável, pesadas indenizações que quebrariam sua economia. Mas o verdadeiro enigma está na profecia sombria contida no final do parágrafo. Havia uma voz de razão, um líder do outro lado do Atlântico, o presidente Woodrow Wilson. Ele viu o que ninguém mais quis ver. Ele entendeu que aquela humilhação excessiva não traria paz, mas sim desejo de vingança. Ele previu o futuro. Encontre a frase onde esse presidente avisa que aquele tratado era tão humilhante que, 'em breve', causaria uma nova guerra. Encontre a semente da Segunda Guerra Mundial plantada nas cinzas da Primeira.",
                paragrafo_original: "Outra consequência da guerra foi o Tratado de Versalhes, assinado em 1919. Apesar do nome, ele foi imposto aos países derrotados. Pelo tratado, os alemães perderam suas colônias na África, parte do próprio território e foram obrigados a pagar pesadas indenizações de guerra aos vencedores. A Alsácia e Lorena passou para o controle francês. Cláusulas militares limitaram o exército alemão a 100 mil soldados... O presidente dos Estados Unidos, Woodrow Wilson, se opôs ao tratado, afirmando que este era humilhante ao povo alemão e que, em breve, uma nova guerra seria travada por causa dele.",
                resposta: "As sanções do Tratado de Versalhes e a previsão de Woodrow Wilson."
            },
            {
                difficulty: 5,
                titulo: "Natureza da Interação de Forças",
                enigma: "Chegamos ao enigma mais profundo da mecânica clássica, uma questão que confunde até estudantes universitários. É sobre a solidão das forças. A Terceira Lei diz que toda ação gera uma reação igual e contrária. Se eu puxo você com 10 Newtons, você me puxa com 10 Newtons. A pergunta filosófica é: se as forças são iguais e contrárias, por que elas não se cancelam? Por que o universo não trava em um equilíbrio estático eterno, com tudo somando zero? A resposta está escondida em uma regra fundamental sobre onde essas forças moram. O seu texto contém uma frase crucial, uma proibição absoluta da natureza. Ele explica que a interação exige necessariamente dois corpos distintos. A minha força atua em você; a sua força atua em mim. Nós nunca trocamos forças dentro de um mesmo objeto. O enigma pede que você encontre a sentença que resolve esse paradoxo. Procure a afirmação categórica que diz ser impossível que o par de ação e reação se forme no mesmo corpo. É essa regra que permite que o movimento exista. Se as forças atuassem no mesmo corpo, elas se anulariam e nada sairia do lugar. Mas como elas atuam em corpos diferentes, o jogo da dinâmica continua. Encontre a explicação sobre a 'mesma intensidade, mesma direção, porém sentidos opostos' e a regra vital sobre a separação dos corpos. Decifre o segredo do movimento.",
                paragrafo_original: "Essa lei permite-nos entender que, para que surja uma força, é necessário que dois corpos interajam, produzindo forças de ação e reação. Além disso, é impossível que um par de ação e reação forme-se no mesmo corpo. Outra informação contida no enunciado da Terceira Lei de Newton indica que os pares de ação e reação têm a mesma intensidade, mesma direção, porém sentidos opostos.",
                resposta: "A explicação de que o par ação-reação nunca atua no mesmo corpo."
            }
        ];

        // --- Funções Auxiliares ---
        const fileToBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        imageInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    selectedImages.push(file);
                    const div = document.createElement('div');
                    div.className = 'relative rounded-xl overflow-hidden shadow-sm border-2 border-pastel-violet-light aspect-square group';
                    div.innerHTML = `<img src="${URL.createObjectURL(file)}" class="w-full h-full object-cover">
                        <button onclick="removeImage(this)" class="absolute top-1 right-1 bg-pastel-red text-white rounded-full p-1 opacity-80 hover:opacity-100">X</button>`;
                    imagePreviewGrid.appendChild(div);
                }
            });
            imageInput.value = '';
        });

        function removeImage(btn) {
            // Lógica simples de remoção visual (idealmente removeria do array também, mas para MVP visual ok)
            btn.parentElement.remove();
        }

        generateBtn.addEventListener('click', async () => {
            if (selectedImages.length === 0) return alert("Por favor, tire fotos do livro primeiro.");
            
            loadingIndicator.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            generateBtn.classList.add('hidden');
            enigmasList.innerHTML = '';
            generatedEnigmasData = [];

            try {
                // Processa em lotes para garantir performance
                const batchSize = 3; // Lote um pouco maior
                for (let i = 0; i < selectedImages.length; i += batchSize) {
                    loadingText.textContent = `Lendo páginas ${i+1} a ${Math.min(i+batchSize, selectedImages.length)}...`;
                    
                    const batchFiles = selectedImages.slice(i, i + batchSize);
                    const batchBase64 = await Promise.all(batchFiles.map(fileToBase64));
                    
                    const enigmas = await generateEnigmasForBatch(batchBase64);
                    generatedEnigmasData = generatedEnigmasData.concat(enigmas);
                }

                // Se gerou pouco (menos de 5), tenta duplicar ou pedir mais (no MVP, vamos apenas exibir)
                if (generatedEnigmasData.length > 0) {
                    displayEnigmas(generatedEnigmasData);
                    resultsArea.classList.remove('hidden');
                } else {
                    alert("A IA não conseguiu ler o texto das imagens. Tente fotos mais claras.");
                }

            } catch (error) {
                console.error(error);
                alert("Erro ao conectar com a mágica. Verifique se o servidor está rodando.");
            } finally {
                loadingIndicator.classList.add('hidden');
                generateBtn.classList.remove('hidden');
            }
        });

        async function generateEnigmasForBatch(imagesBase64) {
            const selectedLevel = parseInt(document.getElementById('difficultySelect').value);
            
            // Filtra exemplos para ajudar a IA
            const relevantExamples = examplesDatabase.filter(ex => ex.difficulty === selectedLevel || ex.difficulty === selectedLevel - 1);
            let examplesText = relevantExamples.map((ex, i) => 
                `EXEMPLO ${i+1}:\nTexto: "${ex.paragrafo_original}"\nEnigma: "${ex.enigma}"\nResposta: "${ex.resposta}"`
            ).join("\n---\n");

            // Prompt ajustado para pedir VÁRIOS enigmas
            const prompt = `Você é um assistente pedagógico criativo (Projeto Educação 4.0).
            
            TAREFA: Analise as imagens de livro didático fornecidas.
            Gere pelo menos 3 a 5 enigmas cooperativos DISTINTOS baseados no texto.
            
            NÍVEL DE DIFICULDADE: ${selectedLevel} (1=Muito Fácil a 5=Expert).
            ESTILO: Use metáforas, rimas ou desafios lógicos. O aluno tem o enigma, o colega tem o livro.
            
            Use estes exemplos como guia de estilo:
            ${examplesText}
            
            FORMATO OBRIGATÓRIO (JSON Array):
            [
                {"titulo": "Título Criativo 1", "pergunta": "Texto do enigma...", "resposta_esperada": "Resposta curta"}
            ]`;

            const response = await fetch('/generate-enigmas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ images: imagesBase64, prompt })
            });

            if (!response.ok) throw new Error('Erro na API');
            const data = await response.json();
            
            try {
                let cleanText = data.enigmasText.replace(/```json/g, '').replace(/```/g, '').trim();
                const json = JSON.parse(cleanText);
                return Array.isArray(json) ? json : [];
            } catch (e) {
                console.error("Erro JSON", e);
                return [];
            }
        }

        function displayEnigmas(enigmas) {
            enigmasList.innerHTML = '';
            enigmas.forEach((enigma, index) => {
                const div = document.createElement('article');
                div.className = 'bg-white rounded-2xl shadow-md border-l-8 border-pastel-violet p-5 hover:shadow-lg transition-all';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold text-pastel-violet-dark">Prova #${index+1}: ${enigma.titulo}</h3>
                        <span class="bg-pastel-green-200 text-pastel-violet-dark text-xs px-2 py-1 rounded-full uppercase font-bold">Nível ${document.getElementById('difficultySelect').value}</span>
                    </div>
                    <p class="text-gray-700 italic mb-4 bg-gray-50 p-3 rounded-lg border border-gray-100">"${enigma.pergunta}"</p>
                    <div class="text-sm bg-pastel-green-100 p-2 rounded text-pastel-violet-dark inline-block">
                        <strong>Gabarito (Só para você):</strong> ${enigma.resposta_esperada}
                    </div>
                `;
                enigmasList.appendChild(div);
            });
        }

        // --- GERAÇÃO DE PDF (A parte mais importante da correção) ---
        downloadPdfBtn.addEventListener('click', () => {
            if (generatedEnigmasData.length === 0) return;

            const doc = new jsPDF();
            const width = doc.internal.pageSize.getWidth();
            const height = doc.internal.pageSize.getHeight();
            
            // 1. GERAÇÃO DAS CARTAS DOS ALUNOS (1 por página)
            generatedEnigmasData.forEach((enigma, index) => {
                if (index > 0) doc.addPage(); // Nova página para cada enigma

                // Borda decorativa
                doc.setDrawColor(149, 117, 205); // Violeta
                doc.setLineWidth(1);
                doc.rect(10, 10, width - 20, height - 20);

                // Cabeçalho da Prova
                doc.setFont("helvetica", "bold");
                doc.setFontSize(24);
                doc.setTextColor(74, 59, 107); // Violeta Escuro
                doc.text(`Enigma Cooperativo #${index + 1}`, width / 2, 40, { align: "center" });
                
                doc.setFontSize(14);
                doc.setTextColor(100);
                doc.text(`Nível de Dificuldade: ${document.getElementById('difficultySelect').value}`, width / 2, 50, { align: "center" });

                // Linha divisória
                doc.setDrawColor(200);
                doc.line(30, 60, width - 30, 60);

                // O Enigma (Texto Grande e Centralizado)
                doc.setFont("helvetica", "italic");
                doc.setFontSize(16);
                doc.setTextColor(0);
                
                const splitText = doc.splitTextToSize(`"${enigma.pergunta}"`, width - 60);
                doc.text(splitText, width / 2, 90, { align: "center" });

                // Instrução Final (Rodapé)
                doc.setFont("helvetica", "normal");
                doc.setFontSize(12);
                doc.setTextColor(150);
                doc.text("Leia este enigma para sua dupla. A resposta está no livro dele(a).", width / 2, height - 30, { align: "center" });
            });

            // 2. GERAÇÃO DA PÁGINA DE GABARITO (Exclusiva do Professor)
            doc.addPage();
            
            // Cabeçalho Gabarito
            doc.setFillColor(74, 59, 107); // Fundo Violeta Escuro
            doc.rect(0, 0, width, 40, 'F');
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22);
            doc.setTextColor(255, 255, 255); // Branco
            doc.text("GABARITO DO PROFESSOR", width / 2, 25, { align: "center" });

            let yPos = 60;
            doc.setTextColor(0); // Preto para texto

            generatedEnigmasData.forEach((enigma, index) => {
                // Título
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text(`Prova #${index + 1}: ${enigma.titulo}`, 20, yPos);
                
                // Resposta
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 100, 0); // Verde Escuro para resposta
                const respostaText = doc.splitTextToSize(`RESPOSTA: ${enigma.resposta_esperada}`, width - 40);
                doc.text(respostaText, 20, yPos + 7);
                
                doc.setTextColor(0); // Reset cor
                yPos += (respostaText.length * 7) + 15;
                
                // Nova página se o gabarito for longo
                if (yPos > height - 20) {
                    doc.addPage();
                    yPos = 20;
                }
            });

            doc.save("Enigmas_Cooperativos_Completo.pdf");
        });
    </script>
</body>
</html>